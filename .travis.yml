language: generic

jobs:
  include:
    # - stage: Testing
    #   language: generic
    #   dist: bionic
    #   before_install:
    #     - sudo apt-get -y install wget
    #     - sudo apt-get -y install tar
    #   install:
    #     - wget https://storage.googleapis.com/flutter_infra/releases/beta/linux/flutter_linux_v1.15.17-beta.tar.xz
    #     - tar -xf flutter_linux_v1.15.17-beta.tar.xz
    #     - ./flutter/bin/flutter doctor
    #     - ./flutter/bin/flutter pub get
    #     - ./flutter/bin/cache/dart-sdk/bin/dartanalyzer lib | internal/static_analyzer.sh
    #   script:
    #     - echo "Begin script"
    #     - ./flutter/bin/flutter test
    #   cache:
    #     directories:
    #       - $HOME/.pub-cache


    - stage: Screenshots
      env:
        - Screenshots on Android
        - OS=linux
      language: generic
      dist: bionic      
      cache:
        directories:
          - ${HOME}/.pub-cache    
      before_install:
        - API=28
        - ABI=x86
        - GOO=default
        - ANDROID_TOOLS=4333796 # android-28
        - ANDROID_HOME=${HOME}/android-sdk
        - GRAVIS="https://raw.githubusercontent.com/DanySK/Gravis-CI/master/"
        - JDK="1.8" # the JDK used for running tests
        # UPDATE PATH
        - export PATH="${HOME}/android-sdk/emulator:${HOME}/android-sdk/tools/bin:${HOME}/android-sdk/platform-tools:$PATH"
        - export PATH="${HOME}/flutter/bin:${HOME}/flutter/bin/cache/dart-sdk/bin:$PATH"
        - export PATH="$PATH":"$HOME/.pub-cache/bin"
        # KVM
        - sudo apt-get -y --no-install-recommends install bridge-utils libpulse0 libvirt-bin qemu-kvm virtinst ubuntu-vm-builder > /dev/null
        # add travis user to groups
        - sudo adduser $USER libvirt
        - sudo adduser $USER kvm
        # Set up JDK 8 for Android SDK
        - curl "${GRAVIS}.install-jdk-travis.sh" --output ~/.install-jdk-travis.sh
        - export TARGET_JDK="${JDK}"
        - JDK="1.8" # used when running sdkmanager
        - source ~/.install-jdk-travis.sh
        - wget -q "https://dl.google.com/android/repository/sdk-tools-linux-$ANDROID_TOOLS.zip" -O android-sdk-tools.zip
        - unzip -q android-sdk-tools.zip -d ${HOME}/android-sdk
        - rm android-sdk-tools.zip
        # Avoid harmless sdkmanager warning
        - mkdir ~/.android
        - echo 'count=0' > ~/.android/repositories.cfg
        - yes | sdkmanager --licenses >/dev/null
      install:
        # INSTALL FLUTTER
        - wget --quiet --output-document=flutter.tar.xz https://storage.googleapis.com/flutter_infra/releases/beta/linux/flutter_linux_v1.15.17-beta.tar.xz
        - tar xf flutter.tar.xz -C $(dirname ${HOME}/flutter)
        - rm flutter.tar.xz
        # ANDROID SDK AND TOOLS
        - sdkmanager "platform-tools" > /dev/null
        - sdkmanager "tools" > /dev/null
        - sdkmanager "build-tools;28.0.3" > /dev/null 
        - sdkmanager "platforms;android-$API" > /dev/null
        - sdkmanager "platforms;android-28" > /dev/null
        - sdkmanager "emulator" > /dev/null
        - sdkmanager "extras;android;m2repository" > /dev/null
        - sdkmanager "system-images;android-$API;$GOO;$ABI" > /dev/null 
        - echo no | avdmanager --verbose create avd --force -n test -k "system-images;android-$API;$GOO;$ABI"
        - ls ${HOME}/android-sdk/emulator
        - sudo -E sudo -u $USER -E bash -c "emulator -avd test -no-window -no-audio &"
        #
        - JDK="${TARGET_JDK}"
        - source ~/.install-jdk-travis.sh
        
      before_script:
        - pub global activate screenshots
        - ./internal/android-wait-for-emulator.sh
        - adb shell getprop ro.product.cpu.abi # 'x86_64' (device)
        - adb shell getprop ro.hardware # 'ranchu' (emulator)
        - adb shell getprop ro.build.characteristics # 'emulator' (emulator)
        - adb shell getprop ro.build.version.release # '9' (emulator)
        - adb shell getprop ro.build.version.sdk # '28' (emulator))
        - adb shell getprop
      script:
        - screenshots -v